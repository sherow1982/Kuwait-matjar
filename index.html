<!doctype html>
<html lang="ar-KW" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>المتجر الكويتي - منتجات مميزة</title>
    <meta name="description" content="منتجات مميزة يتم تحديثها تلقائيًا من المتجر الكويتي.">
    <link rel="canonical" href="https://sherow1982.github.io/Kuwait-matjar/">
    <meta name="theme-color" content="#3aa77a">
    
    <!-- === التغيير هنا: تم تحديث المسار ليقرأ من الجذر مباشرة === -->
    <link rel="preload" href="./woodmart-lite.css" as="style" fetchpriority="high">
    <link rel="stylesheet" href="./woodmart-lite.css">
    
    <link rel="icon" href="./assets/icons/favicon.ico">
</head>
<body>
    <header class="header">
        <div class="header__inner container">
            <a href="/" class="header__logo">المتجر الكويتي</a>
            <div class="header__spacer"></div>
            <p style="margin:0; color:var(--muted);">أحدث المنتجات والعروض</p>
        </div>
    </header>
    <main class="section">
        <div id="products-container" class="container" aria-live="polite" aria-busy="true">
            <!-- Products will be rendered here by JavaScript -->
        </div>
    </main>
    <footer class="footer">
        <div class="container footer__bottom">
            <p>© 2025 المتجر الكويتي - جميع الحقوق محفوظة</p>
        </div>
    </footer>
    <script type="module">
        const DATA_URL = 'https://raw.githubusercontent.com/sherow1982/Kuwait-matjar/refs/heads/main/data/products-template.json?raw=1';
        const container = document.getElementById('products-container');

        const escapeHTML = (str) => String(str ?? '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
        const parsePrice = (priceStr) => priceStr ? parseFloat(String(priceStr).replace(/[^0-9.]/g, '')) : null;
        const formatKD = (val) => typeof val === 'number' ? new Intl.NumberFormat('ar-KW', { style: 'currency', currency: 'KWD' }).format(val) : '';
        const slugify = (text) => text ? text.toString().toLowerCase().trim().replace(/\s+/g, '-').replace(/[^\u0600-\u06FFa-z0-9-]/g, '').replace(/-+/g, '-') : '';

        const createProductCard = (p = {}) => {
            const title = escapeHTML(p['العنوان']);
            const image = escapeHTML(p['رابط الصورة']);
            const productSlug = slugify(title);
            const productPageLink = `./product.html?name=${productSlug}`;
            
            const salePriceNum = parsePrice(p['السعر المخفّض']);
            const regularPriceNum = parsePrice(p['السعر']);
            
            const currentPriceHTML = formatKD(salePriceNum ?? regularPriceNum);
            const oldPriceHTML = salePriceNum ? `<s>${formatKD(regularPriceNum)}</s>` : '';
            const saleBadge = salePriceNum ? '<span class="product__badge">تخفيضات</span>' : '';

            return `
                <div class="product">
                    <a href="${productPageLink}" class="product__media">
                        ${saleBadge}
                        <img src="${image}" alt="${title}" loading="lazy" decoding="async">
                    </a>
                    <div class="product__body">
                        <h3 class="product__title">
                            <a href="${productPageLink}">${title}</a>
                        </h3>
                        <div class="price">
                            ${oldPriceHTML}
                            <span>${currentPriceHTML}</span>
                        </div>
                    </div>
                </div>
            `;
        };
      
        const renderProducts = (items) => {
            if (container && Array.isArray(items) && items.length) {
                container.innerHTML = `<div class="products">${items.map(createProductCard).join('')}</div>`;
            } else if (container) {
                container.innerHTML = '<p>عفواً، لم يتم العثور على منتجات حالياً.</p>';
            }
        };

        (async () => {
            try {
                const res = await fetch(DATA_URL, { cache: 'no-store' });
                if (!res.ok) throw new Error('فشل تحميل المنتجات');
                const items = await res.json();
                renderProducts(items);
            } catch (error) {
                console.error("Failed to fetch products:", error);
            }
        })();
    </script>
</body>
</html>
