<!doctype html>
<html lang="ar-KW" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>المتجر الكويتي - منتجات مميزة</title>
    <meta name="description" content="منتجات مميزة يتم تحديثها تلقائيًا من المتجر الكويتي.">
    <link rel="canonical" href="https://sherow1982.github.io/Kuwait-matjar/">
    <meta name="theme-color" content="#3aa77a">
    <link rel="preload" href="https://raw.githubusercontent.com/sherow1982/Kuwait-matjar/refs/heads/main/assets/woodmart-lite.css?raw=1" as="style" fetchpriority="high">
    <link rel="stylesheet" href="https://raw.githubusercontent.com/sherow1982/Kuwait-matjar/refs/heads/main/assets/woodmart-lite.css?raw=1">
    <link rel="icon" href="./assets/icons/favicon.ico">
</head>
<body>
    <header class="header">
        <div class="header__inner container">
            <a href="/" class="header__logo">المتجر الكويتي</a>
            <div class="header__spacer"></div>
            <p style="margin:0; color:var(--muted);">أحدث المنتجات والعروض</p>
        </div>
    </header>
    <main class="section">
        <div id="products-container" class="container" aria-live="polite" aria-busy="true">
            <div class="products">
                <div class="product skeleton" style="aspect-ratio: 1/1.2;"></div>
                <div class="product skeleton" style="aspect-ratio: 1/1.2;"></div>
                <div class="product skeleton" style="aspect-ratio: 1/1.2;"></div>
                <div class="product skeleton" style="aspect-ratio: 1/1.2;"></div>
            </div>
        </div>
    </main>
    <footer class="footer">
        <div class="container footer__bottom">
            <p>© 2025 المتجر الكويتي - جميع الحقوق محفوظة</p>
        </div>
    </footer>
    <script type="module">
        const DATA_URL = 'https://raw.githubusercontent.com/sherow1982/Kuwait-matjar/refs/heads/main/data/products-template.json?raw=1';
        const container = document.getElementById('products-container');

        const escapeHTML = (str) => String(str ?? '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
        const parsePrice = (priceStr) => priceStr ? parseFloat(String(priceStr).replace(/[^0-9.]/g, '')) : null;
        const formatKD = (val) => typeof val === 'number' ? new Intl.NumberFormat('ar-KW', { style: 'currency', currency: 'KWD' }).format(val) : '';

        /**
         * --- التغيير الأول: إضافة دالة لإنشاء رابط نصي (Slug) ---
         * هذه الدالة تحول العنوان إلى رابط صالح للاستخدام في الـ URL.
         */
        const slugify = (text) => {
            if (!text) return '';
            return text.toString().toLowerCase().trim()
                .replace(/\s+/g, '-') // استبدال المسافات بـ -
                .replace(/[^\u0600-\u06FFa-z0-9-]/g, '') // إزالة الأحرف غير المرغوبة
                .replace(/-+/g, '-'); // إزالة الشرطات المتكررة
        };

        const createProductCard = (p = {}) => {
            const title = escapeHTML(p['العنوان']);
            const image = escapeHTML(p['رابط الصورة']);
            const originalLink = escapeHTML(p['الرابط']);
            
            // --- التغيير الثاني: إنشاء الرابط الجديد باستخدام الدالة slugify ---
            const productSlug = slugify(title);
            const productPageLink = `./product.html?name=${productSlug}`;
            
            const salePriceNum = parsePrice(p['السعر المخفّض']);
            const regularPriceNum = parsePrice(p['السعر']);
            const currentPrice = formatKD(salePriceNum ?? regularPriceNum);
            const oldPrice = salePriceNum ? `<s>${formatKD(regularPriceNum)}</s>` : '';

            return `
                <div class="product">
                    <div class="product__media">
                        <a href="${productPageLink}">
                            <img src="${image}" alt="${title}" loading="lazy" decoding="async">
                        </a>
                        <div class="product__hover">
                            <a href="${originalLink}" target="_blank" rel="noopener noreferrer" class="btn btn--sm">شراء الآن</a>
                        </div>
                    </div>
                    <div class="product__body">
                        <h3 class="product__title">
                            <a href="${productPageLink}">${title}</a>
                        </h3>
                        <div class="price">
                            ${currentPrice} ${oldPrice}
                        </div>
                    </div>
                </div>
            `;
        };
      
        const renderProducts = (items) => {
            if (!container) return;
            if (Array.isArray(items) && items.length) {
                container.innerHTML = `<div class="products">${items.map(createProductCard).join('')}</div>`;
            } else {
                container.innerHTML = '<p>عفواً، لم يتم العثور على منتجات حالياً.</p>';
            }
            container.setAttribute('aria-busy', 'false');
        };

        (async () => {
            try {
                const res = await fetch(DATA_URL, { cache: 'no-store' });
                if (!res.ok) throw new Error('فشل تحميل المنتجات');
                const items = await res.json();
                renderProducts(items);
            } catch (error) {
                console.error("Failed to fetch products:", error);
            }
        })();
    </script>
</body>
</html>
