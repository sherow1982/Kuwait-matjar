<!doctype html>
<html lang="ar-KW" dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل المنتج</title>

    <!-- === التغيير هنا: تم تحديث المسار ليقرأ من الجذر مباشرة === -->
    <link rel="stylesheet" href="./woodmart-lite.css">

</head>
<body>
    <header class="header">
        <div class="header__inner container">
            <a href="/" class="header__logo">العودة للمتجر</a>
        </div>
    </header>

    <main class="section">
        <div id="product-content" class="container">
            <p>جارٍ تحميل المنتج...</p>
        </div>
    </main>

    <footer class="footer">
        <div class="container footer__bottom">
            <p>© 2025 المتجر الكويتي</p>
        </div>
    </footer>

    <script type="module">
        const content = document.getElementById('product-content');

        const escapeHTML = (str) => String(str ?? '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
        const parsePrice = (priceStr) => priceStr ? parseFloat(String(priceStr).replace(/[^0-9.]/g, '')) : null;
        const formatKD = (val) => typeof val === 'number' ? new Intl.NumberFormat('ar-KW', { style: 'currency', currency: 'KWD' }).format(val) : '';
        const slugify = (text) => text ? text.toString().toLowerCase().trim().replace(/\s+/g, '-').replace(/[^\u0600-\u06FFa-z0-9-]/g, '').replace(/-+/g, '-') : '';

        const renderProductDetails = (product) => {
            if (!product) {
                content.innerHTML = '<p>عفواً، هذا المنتج غير موجود.</p>';
                return;
            }

            document.title = product['العنوان'];
            
            const title = escapeHTML(product['العنوان']);
            const image = escapeHTML(product['رابط الصورة']);
            const description = escapeHTML(product['الوصف']).replace(/\n/g, '<br>');
            const originalLink = product['الرابط'];
            
            const salePriceNum = parsePrice(product['السعر المخفّض']);
            const regularPriceNum = parsePrice(product['السعر']);
            const currentPrice = formatKD(salePriceNum ?? regularPriceNum);
            const oldPrice = salePriceNum ? `<s>${formatKD(regularPriceNum)}</s>` : '';

            content.innerHTML = `
                <div class="product-details">
                    <div class="product-gallery">
                        <img src="${image}" alt="${title}">
                    </div>
                    <div class="product-info">
                        <h1 class="h1">${title}</h1>
                        <div class="price">${currentPrice} ${oldPrice}</div>
                        <p class="product-description">${description}</p>
                        <a href="${originalLink}" target="_blank" rel="noopener noreferrer" class="btn buy-button">
                            اشترِ الآن من المتجر الأصلي
                        </a>
                    </div>
                </div>
            `;
        };

        (async () => {
            try {
                const params = new URLSearchParams(window.location.search);
                const productSlug = params.get('name');
                if (!productSlug) throw new Error('رابط المنتج غير صحيح.');

                const res = await fetch('https://raw.githubusercontent.com/sherow1982/Kuwait-matjar/refs/heads/main/data/products-template.json?raw=1', { cache: 'no-store' });
                if (!res.ok) throw new Error('فشل تحميل بيانات المنتجات');
                
                const allProducts = await res.json();
                const product = allProducts.find(p => slugify(p['العنوان']) === productSlug);
                renderProductDetails(product);

            } catch (error) {
                console.error(error);
                content.innerHTML = `<p>حدث خطأ: ${error.message}</p>`;
            }
        })();
    </script>
</body>
</html>
